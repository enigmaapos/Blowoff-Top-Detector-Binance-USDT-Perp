<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Blowoff Top Detector ‚Äî Hybrid UI (Table + Cards)</title>

<style>
  :root{
    --bg:#07101a;
    --card:#0b1220;
    --muted:#9fb3cc;
    --accent:#2dd4bf;
    --danger:#ff7b7b;
  }

  body{
    font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;
    background:var(--bg);
    color:#e6eef8;
    margin:16px;
  }

  .card-panel{
    background:var(--card);
    border:1px solid #172033;
    padding:14px;
    border-radius:10px;
    box-shadow:0 6px 20px rgba(0,0,0,.6);
    margin-bottom:16px;
  }

  h1{margin:0;font-size:18px}

  .controls{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:12px;
    align-items:center
  }

  label{font-size:13px;color:var(--muted)}

  input, select{
    background:#071722;
    border:1px solid #243241;
    color:#e6eef8;
    padding:6px;
    border-radius:6px;
  }

  button{
    background:#1f6feb;
    border:none;
    color:white;
    padding:8px 10px;
    border-radius:6px;
    cursor:pointer;
  }

  button.alt{ background:#2b3947 }

  .status{
    margin-top:8px;
    color:var(--muted);
    font-size:13px;
    display:flex;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
  }

  .progress{
    height:8px;
    background:#05101a;
    border-radius:4px;
    margin-top:8px;
    overflow:hidden;
    flex:1
  }

  .progress > i{
    display:block;
    height:100%;
    background:linear-gradient(90deg,var(--accent),#60a5fa);
    width:0%
  }

  .countdown{
    font-weight:700;
    color:#cfe8ff;
  }

  .mutedBadge{
    background:rgba(255,255,255,0.03);
    color:var(--muted);
    padding:4px 8px;
    border-radius:8px;
    font-size:12px;
  }

  /* DESKTOP TABLE VIEW */
  #tableView{ display:block }
  #cardView{ display:none }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
    font-size:13px;
    min-width:700px;
  }

  th, td{
    padding:8px 10px;
    border-bottom:1px dashed #122331;
    text-align:left;
  }

  th{
    color:var(--muted);
    font-size:12px
  }

  .green{ color:#66f9a1 }
  .red{ color:var(--danger) }
  .small{ font-size:12px;color:var(--muted) }

  .blink{
    animation: blinkHighlight 1.8s ease-in-out 3;
  }

  @keyframes blinkHighlight {
    0% { box-shadow:0 0 0px rgba(255,80,80,0.0); }
    50% { box-shadow:0 0 12px rgba(255,80,80,0.35); }
    100% { box-shadow:0 0 0px rgba(255,80,80,0.0); }
  }

  /* MOBILE CARD UI */
  @media (max-width:680px){

    #tableView{ display:none }
    #cardView{ display:block }

    .coinCard{
      background:var(--card);
      border:1px solid #172033;
      padding:12px;
      border-radius:10px;
      margin-bottom:10px;
    }

    .coinRow1{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .coinSymbol{
      font-size:16px;
      font-weight:700;
    }

    .coinScore{
      font-size:14px;
      font-weight:700;
    }

    .blowBadge{
      background:#ff4d4d;
      padding:4px 8px;
      border-radius:6px;
      color:white;
      font-size:12px;
      font-weight:700;
    }

    .potBadge{
      background:#ffd966;
      padding:4px 8px;
      border-radius:6px;
      color:black;
      font-size:12px;
      font-weight:700;
    }

    .sigList{
      margin-top:8px;
      font-size:12px;
      line-height:18px;
      color:#cce3ff;
    }
  }
</style>
</head>
<body>

  <div class="card-panel">
  <h1>Blowoff Top Detector ‚Äî Hybrid UI</h1>
  <div class="small" style="margin-top:6px;color:var(--muted)">
    Auto scans top N futures by 24h change.  
    Blowoff signals: RSI, wick, volume spike, lower-high, funding, EMA distance.  
    Desktop = Table view. Mobile = Card view.
  </div>

  <div class="controls">
    <label>Prefilter <input id="prefilter" type="number" value="30" min="5" max="100"></label>
    <label>Delay (ms) <input id="delay" type="number" value="450" min="50" max="2000"></label>
    <label>Refresh (sec) <input id="interval" type="number" value="60" min="10" max="3600"></label>
    <label>Score ‚â• <input id="threshold" type="number" value="4" min="1" max="6"></label>
    <button id="startBtn">Start</button>
    <button id="stopBtn" class="alt" disabled>Stop</button>
    <button id="oneShot" class="alt">Run Once</button>
  </div>

  <div class="status">
    <div id="message">Ready.</div>
    <div class="progress"><i id="bar"></i></div>
    <div id="countdown" class="countdown">Next scan in: -</div>
    <div id="safetyStatus" class="mutedBadge">Safety OK</div>
  </div>

  <!-- DESKTOP TABLE VIEW -->
  <div id="tableView"></div>

  <!-- MOBILE CARD VIEW -->
  <div id="cardView"></div>

  <div id="debug" class="small" style="margin-top:10px"></div>
</div>

<script>
/* ---------------------------------------------------------
   HYBRID ENGINE (Desktop Table + Mobile Card)
   All original logic preserved, only rendering changed.
   --------------------------------------------------------- */

const API_BASE = "https://fapi.binance.com";

// ------- BLACKLIST -------
const blacklist = [
  "ALPACAUSDT","BNXUSDT","ALPHAUSDT","OCEANUSDT","DGBUSDT",
  "AGIXUSDT","LINAUSDT","LOKAUSDT","KEYUSDT","MDTUSDT",
  "LOOMUSDT","RENUSDT","OMNIUSDT","SLERFUSDT","STMXUSDT",
  "UXLINKUSDT","BSWUSDT","NEIROETHUSDT","VIDTUSDT","TROYUSDT",
  "BAKEUSDT","AMBUSDT","MEMEFIUSDT","NULSUSDT","HIFIUSDT",
  "LEVERUSDT","XEMUSDT","STRAXUSDT","COMBOUSDT"
];

const el = {
  prefilter: document.getElementById("prefilter"),
  delay: document.getElementById("delay"),
  interval: document.getElementById("interval"),
  threshold: document.getElementById("threshold"),

  startBtn: document.getElementById("startBtn"),
  stopBtn: document.getElementById("stopBtn"),
  oneShot: document.getElementById("oneShot"),

  message: document.getElementById("message"),
  bar: document.getElementById("bar"),
  tableView: document.getElementById("tableView"),
  cardView: document.getElementById("cardView"),

  debug: document.getElementById("debug"),
  safetyStatus: document.getElementById("safetyStatus"),
  countdown: document.getElementById("countdown")
};

// ------- RUNTIME STATE -------
let running = false;
let queue = [];
let totalTasks = 0;
let doneTasks = 0;

let autoTimer = null;
let countdownTimer = null;

// SAFETY WINDOW
let requestsThisWindow = 0;
let windowStart = Date.now();
const SAFETY_WINDOW = 60000;
const SAFETY_MAX = 900;
const SAFETY_PAUSE = 30;

// track previous blowoffs
let prevBlow = new Set();

/* ---------------------------------------------------------
   API SAFE FETCH
--------------------------------------------------------- */
async function safeFetch(url){
  if (!running) throw new Error("Not running");
  requestsThisWindow++;

  return fetch(url).then(r=>{
    if(!r.ok) throw new Error("HTTP " + r.status);
    return r.json();
  });
}

/* ---------------------------------------------------------
   TECHNICAL INDICATORS
--------------------------------------------------------- */
function sma(arr,n){
  if(!arr || arr.length < n) return null;
  let s = 0;
  for(let i=arr.length-n;i<arr.length;i++) s += arr[i];
  return s/n;
}
function ema(arr, period){
  if(!arr || arr.length === 0) return null;
  const k = 2/(period+1);
  let e = arr[0];
  for(let i=1;i<arr.length;i++) e = arr[i]*k + e*(1-k);
  return e;
}
function rsiFromCloses(closes, period=14){
  if(!closes || closes.length <= period) return null;
  let gains=0,losses=0;
  for(let i=closes.length-period;i<closes.length;i++){
    const diff = closes[i]-closes[i-1];
    if(diff>0) gains+=diff; else losses+=Math.abs(diff);
  }
  if(losses===0) return 100;
  const rs = gains/period / (losses/period);
  return 100 - (100/(1+rs));
}
function pct(a,b){ return b===0 ? 0 : ((a-b)/b)*100; }

/* ---------------------------------------------------------
   SAFETY MECHANISM
--------------------------------------------------------- */
function resetWindow(){
  requestsThisWindow = 0;
  windowStart = Date.now();
}
function safetyCheck(){
  const now = Date.now();
  if (now - windowStart > SAFETY_WINDOW){
    resetWindow();
    el.safetyStatus.innerText = "Safety OK";
    return false;
  }
  if (requestsThisWindow > SAFETY_MAX){
    running = false;
    el.safetyStatus.innerText = "Auto-paused (rate limit)";
    el.message.innerText = `Paused ${SAFETY_PAUSE}s`;
    el.stopBtn.disabled = true;
    el.startBtn.disabled = false;

    setTimeout(()=>{
      el.safetyStatus.innerText = "Resuming";
      let d = Number(el.delay.value);
      el.delay.value = Math.min(2000, Math.round(d*1.4));
      resetWindow();
    }, SAFETY_PAUSE*1000);

    return true;
  }
  el.safetyStatus.innerText = "Req/min: "+requestsThisWindow;
  return false;
}

/* ---------------------------------------------------------
   QUEUE PROCESSOR
--------------------------------------------------------- */
async function processQueue(){
  const delay = Number(el.delay.value) || 450;

  while(queue.length && running){
    if(safetyCheck()) break;

    const job = queue.shift();
    try{ await job(); }
    catch(e){ el.debug.innerText += "\nJob error: "+e.message; }

    doneTasks++;
    updateProgress();

    await new Promise(r=>setTimeout(r, delay));
  }

  running = false;
  el.startBtn.disabled = false;
  el.stopBtn.disabled = true;
  el.message.innerText = "Scan complete.";
}

/* ---------------------------------------------------------
   FETCH TOP SYMBOLS
--------------------------------------------------------- */
async function getTopN(n){
  const tick = await safeFetch(API_BASE+"/fapi/v1/ticker/24hr");
  const list = tick.filter(x=>x.symbol.endsWith("USDT") && !blacklist.includes(x.symbol));

  list.sort((a,b)=> b.priceChangePercent - a.priceChangePercent);
  return list.slice(0,n).map(t=>({
    symbol: t.symbol,
    last: Number(t.lastPrice),
    change24: Number(t.priceChangePercent)
  }));
}

/* ---------------------------------------------------------
   QUEUE SYMBOL ANALYSIS
--------------------------------------------------------- */
function queueSymbol(symbol, results){
  queue.push(async ()=>{
    try{
      const [k1d, k4h, k15, fund] = await Promise.all([
        safeFetch(`${API_BASE}/fapi/v1/klines?symbol=${symbol}&interval=1d&limit=9`),
        safeFetch(`${API_BASE}/fapi/v1/klines?symbol=${symbol}&interval=4h&limit=20`),
        safeFetch(`${API_BASE}/fapi/v1/klines?symbol=${symbol}&interval=15m&limit=30`),
        safeFetch(`${API_BASE}/fapi/v1/fundingRate?symbol=${symbol}&limit=1`)
      ]);

      const c1d = k1d.map(k=>Number(k[4]));
      const c4h = k4h.map(k=>Number(k[4]));
      const v4h = k4h.map(k=>Number(k[5]));
      const last4 = k4h[k4h.length-1];
      const prev4 = k4h[k4h.length-2];

      const open4 = Number(last4[1]);
      const high4 = Number(last4[2]);
      const close4= Number(last4[4]);

      const body = Math.abs(close4-open4)||1e-9;
      const wickTop = high4 - Math.max(open4,close4);
      const wickRatio = wickTop/body;

      const volMA = sma(v4h, Math.min(10, v4h.length));
      const volSpike = volMA ? Number((v4h[v4h.length-1]/volMA).toFixed(2)) : 1;

      const ema70 = ema(c4h, 70);
      const distPct = ema70 ? pct(close4, ema70) : 0;

      const rsi1d = rsiFromCloses(c1d, 14);
      const rsi4h = rsiFromCloses(c4h, 14);

      const lowerHigh = Number(last4[2]) < Number(prev4[2]);

      const funding = fund && fund.length ? Number(fund[0].fundingRate) : 0;

      let score=0;
      let s={};

      if(rsi1d>=88){ score++; s.rsi1d=true; }
      if(rsi4h>=80){ score++; s.rsi4h=true; }
      if(volSpike>=1.8){ score++; s.volSpike=true; }
      if(wickRatio>=1.2){ score++; s.wickTop=true; }
      if(distPct>=50){ score++; s.emaDist=true; }
      if(lowerHigh){ score++; s.lowerHigh=true; }
      if(funding < -0.0005){ score++; s.fundingConfirm=true; }
      s.funding = funding;

      results.push({
        symbol, score, rsi4h, rsi1d,
        volSpike, wickRatio,
        ema70DistPct: Number(distPct.toFixed(2)),
        lowerHigh, funding,
        last: close4,
        change24: null,
        s
      });

    }catch(e){
      el.debug.innerText += `\nError ${symbol}: ${e.message}`;
    }
  });
}

/* ---------------------------------------------------------
   UPDATE PROGRESS BAR
--------------------------------------------------------- */
function updateProgress(){
  if(!totalTasks) return;
  const pct = Math.round((doneTasks/totalTasks)*100);
  el.bar.style.width = pct+"%";
  el.message.innerText = `Scanning ${doneTasks}/${totalTasks} (${pct}%)`;
}

/* ---------------------------------------------------------
   COUNTDOWN
--------------------------------------------------------- */
function startCountdown(sec){
  if(countdownTimer) clearInterval(countdownTimer);
  const end = Date.now() + sec*1000;

  countdownTimer = setInterval(()=>{
    let left = Math.max(0, end - Date.now());
    let s = Math.round(left/1000);

    el.countdown.innerText = "Next scan in: " + s + "s";

    if(s <= 0){
      clearInterval(countdownTimer);
      el.countdown.innerText = "Running...";
    }
  }, 500);
}

/* ---------------------------------------------------------
   HYBRID RENDERER
   - If screen width >= 680px => TABLE
   - else => CARD
--------------------------------------------------------- */
function renderHybrid(results){
  if (window.innerWidth >= 680){
    renderTable(results);
  } else {
    renderCards(results);
  }
}

/* ---------------------------------------------------------
   DESKTOP TABLE RENDER
--------------------------------------------------------- */
function renderTable(results){
  const th = `
    <table>
      <thead>
        <tr>
          <th>Symbol/Status</th>
          <th>Last</th>
          <th>RSI4H</th>
          <th>Signals</th>
          <th>Funding</th>
        </tr>
      </thead>
      <tbody>
  `;

  const rows = results.map(r=>{
    let status = "normal";
    let bg = "background:rgba(255,255,255,0.02);";
    let cls = "";

    if(r.score>=4){
      status = `<span style="background:#ff4d4d;color:white;font-size:11px;padding:4px 6px;border-radius:6px">üî• BLOWOFF</span>`;
      bg = "background:rgba(255,40,40,0.18);";
      if(!prevBlow.has(r.symbol)) cls="blink";
    }
    else if(r.score===3){
      status = `<span style="background:#ffd966;color:black;font-size:11px;padding:4px 6px;border-radius:6px">‚ö†Ô∏è Potential</span>`;
      bg = "background:rgba(255,200,0,0.14);";
    }

    return `
      <tr class="${cls}" style="${bg}">
        <td><strong>${r.symbol}</strong><br>${status}</td>
        <td>${r.last}</td>
        <td class="${r.rsi4h>=80?'green':''}">${r.rsi4h?.toFixed(1) ?? 'n/a'}</td>
        <td class="small">vol:${r.volSpike} wick:${r.wickRatio.toFixed(2)} ema:${r.ema70DistPct}%</td>
        <td class="small">${r.funding}</td>
      </tr>
    `;
  }).join("");

  el.tableView.innerHTML = `<div class="card-panel">${th}${rows}</tbody></table></div>`;
}

/* ---------------------------------------------------------
   MOBILE CARD RENDER
--------------------------------------------------------- */
function renderCards(results){
  let html = "";

  results.forEach(r=>{
    let badge = `<span class="small" style="color:var(--muted)">normal</span>`;
    let cls = "";

    if(r.score>=4){
      badge = `<span class="blowBadge">üî• Blowoff</span>`;
      cls = (!prevBlow.has(r.symbol) ? "blink" : "");
    }
    else if(r.score===3){
      badge = `<span class="potBadge">‚ö† Potential</span>`;
    }

    html += `
      <div class="coinCard ${cls}">
        <div class="coinRow1">
          <div class="coinSymbol">${r.symbol}</div>
          <div class="coinScore">${r.score}/6</div>
        </div>

        <div style="margin-top:4px">${badge}</div>

        <div class="sigList">
          Last: ${r.last}<br>
          RSI4H: ${r.rsi4h?.toFixed(1) ?? 'n/a'}<br>
          Vol Spike: ${r.volSpike}<br>
          Wick Ratio: ${r.wickRatio.toFixed(2)}<br>
          EMA70 Dist: ${r.ema70DistPct}%<br>
          Funding: ${r.funding}<br>
        </div>
      </div>
    `;
  });

  el.cardView.innerHTML = `<div class="card-panel">${html}</div>`;
}

/* ---------------------------------------------------------
   FINAL RENDER ENTRYPOINT
--------------------------------------------------------- */
function renderResults(results){
  results.sort((a,b)=> b.score - a.score);

  const blowSet = new Set(results.filter(r=>r.score>=4).map(r=>r.symbol));
  prevBlow = blowSet;

  renderHybrid(results);
}

/* ---------------------------------------------------------
   MAIN SCAN CYCLE
--------------------------------------------------------- */
async function runScan(once=false){
  try{
    running = true;
    el.startBtn.disabled = true;
    el.stopBtn.disabled = false;
    el.debug.innerText = "";
    el.message.innerText = "Fetching top symbols...";
    resetWindow();

    const N = Number(el.prefilter.value);
    const delay = Number(el.delay.value);
    const sec = Number(el.interval.value);

    const top = await getTopN(N);
    const results = [];

    queue = [];
    totalTasks = top.length;
    doneTasks = 0;
    updateProgress();

    top.forEach(x=> queueSymbol(x.symbol, results));

    if(!once) startCountdown(sec);

    processQueue().then(()=>{
      renderResults(results);

      if(!once && running){
        if(autoTimer) clearInterval(autoTimer);
        autoTimer = setInterval(()=> runScan(false), sec*1000);
      }
    });
  }
  catch(e){
    el.debug.innerText += "\nScan error: "+e.message;
  }
}

/* ---------------------------------------------------------
   UI EVENTS
--------------------------------------------------------- */
el.startBtn.addEventListener("click", ()=> runScan(false));
el.stopBtn.addEventListener("click", ()=>{
  running = false;
  queue = [];
  el.startBtn.disabled = false;
  el.stopBtn.disabled = true;
});
el.oneShot.addEventListener("click", ()=> runScan(true));

  
/* ---------------------------------------------------------
   SOUND + NOTIFICATION HELPERS (FINAL SECTION)
--------------------------------------------------------- */

function playAlertSound(){
  try{
    const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    audio.volume = 0.7;
    audio.play().catch(()=>{});
  }catch(e){}
}

function notify(title, body){
  if(Notification.permission === "granted"){
    new Notification(title, { body });
  }
}

// Request notification permission at load
if("Notification" in window){
  try { Notification.requestPermission(); }
  catch(e){}
}

/* ---------------------------------------------------------
   HOOK ALERTS TO SCORE DETECTION
--------------------------------------------------------- */

function alertIfNeeded(results){
  const flagged = results.filter(r=>r.score >= 4);

  if(flagged.length > 0){
    playAlertSound();
    notify("üî• Blowoff Top Detected", flagged[0].symbol + " triggered blowoff conditions.");
  }
}

// Patch renderResults to include alert checks
const _origRenderResults = renderResults;
renderResults = function(results){
  _origRenderResults(results);
  alertIfNeeded(results);
};

</script>

  </body>
</html>
